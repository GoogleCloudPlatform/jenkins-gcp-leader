{
  "variables": {
    "name": "jenkins-gcp-leader",
    "git_commit": "",
    "git_branch": "",
    "account_file": "",
    "project_id": "null"
  },
  "builders": [
    {
      "type": "docker",
      "image": "jenkins:1.609.2",
      "run_command": ["-d", "-i", "-t", "-u", "root", "{{.Image}}", "/bin/bash"],
      "commit": "true" 
    }
  ],
  "provisioners": [
    {
      "type": "file",
      "source": "plugins.txt",
      "destination": "/usr/share/jenkins/plugins.txt"
    },
    {
      "type": "file",
      "source": "jenkins/jobs",
      "destination": "/usr/share/jenkins/ref"
    },
    {
      "type": "file",
      "source": "start.sh",
      "destination": "/usr/local/bin/start.sh"
    },
    {
      "type": "shell",
      "environment_vars" : [ "CLOUDSDK_CORE_DISABLE_PROMPTS=1" ],
      "inline": [
        "curl https://sdk.cloud.google.com | bash"
        "chmod +x /usr/local/bin/start.sh",
        "/usr/local/bin/plugins.sh /usr/share/jenkins/plugins.txt"
      ]
    }
  ],
  "post-processors": [
    [
        {
            "type": "docker-tag",
            "repository": "gcr.io/{{user `project_id`}}/{{user `name`}}",
            "tag": "{{user `git_branch`}}-{{user `git_commit`}}",
            "only": ["docker"]
        }
    ]
  ]
}
